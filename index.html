<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ’éŠæœƒ POS Pro (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
            
            --color-food: #f97316;
            --color-drink: #0ea5e9;
            --color-game: #8b5cf6;
            --color-anime: #ec4899;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); height: 100vh; overflow: hidden; color: #1e293b; }
        button, select, input { font-family: inherit; outline: none; }

        /* --- 1. è§’è‰²é¸æ“‡ --- */
        #role-selection-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
        }
        .landing-title { font-size: 3.5rem; font-weight: 800; color: white; margin-bottom: 40px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); letter-spacing: 2px; }
        .role-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 90%; max-width: 700px; }
        .role-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
            padding: 30px; text-align: center; cursor: pointer; color: white;
            transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .role-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.2); box-shadow: 0 20px 30px rgba(0,0,0,0.3); }
        .role-icon { font-size: 3rem; }
        .role-name { font-size: 1.4rem; font-weight: bold; }
        .role-full-width { grid-column: span 2; background: linear-gradient(to right, #4f46e5, #3b82f6); }
        .role-pickup { grid-column: span 2; background: linear-gradient(to right, #f59e0b, #d97706); }

        /* --- 2. ç¸½å‹™ POS --- */
        #cashier-app { display: none; height: 100%; width: 100%; }
        .pos-layout { display: flex; height: 100%; }
        
        .menu-area { flex: 7; display: flex; flex-direction: column; padding: 15px; gap: 10px; }
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .cat-btn {
            background: white; border: none; padding: 10px 20px; border-radius: 50px;
            font-weight: 600; color: var(--secondary); cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s; white-space: nowrap;
        }
        .cat-btn.active { background: #334155; color: white; transform: scale(1.05); }
        .cat-btn[data-group="é£Ÿç‰©çµ„"].active { background: var(--color-food); }
        .cat-btn[data-group="é£²æ–™çµ„"].active { background: var(--color-drink); }
        .cat-btn[data-group="History"].active { background: var(--danger); }

        .product-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 15px; overflow-y: auto; padding-bottom: 20px; flex: 1; align-content: flex-start;
        }
        .product-card {
            background: white; border-radius: var(--radius); padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: space-between; height: 110px;
            border-left: 5px solid #ccc; position: relative; overflow: hidden;
        }
        .product-card:active { transform: scale(0.95); }
        .product-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; line-height: 1.2; }
        .product-price { font-size: 1.2rem; font-weight: 800; color: var(--primary); text-align: right; }
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 5px; width: fit-content;}

        .cart-area { 
            flex: 3; background: white; display: flex; flex-direction: column; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.05); min-width: 360px; max-width: 420px; z-index: 10;
        }
        .cart-header { padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;}
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-item { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; 
            padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; animation: fadeIn 0.3s;
        }
        .btn-remove { background: #fee2e2; color: #ef4444; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;}

        .control-panel { padding: 20px; background: white; border-top: 1px solid #e2e8f0; }
        .price-row { display: flex; justify-content: space-between; font-size: 1.6rem; font-weight: 800; margin-bottom: 10px; color: #0f172a; }
        .input-pay { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1.2rem; margin-bottom: 10px; text-align: right; }
        .btn-checkout { 
            width: 100%; background: var(--primary); color: white; border: none; padding: 15px; 
            border-radius: 8px; font-size: 1.3rem; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); transition: 0.2s; margin-bottom: 15px;
        }
        
        .admin-panel { background: #f1f5f9; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1; }
        .admin-title { font-size: 0.85rem; font-weight: bold; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-admin { background: white; border: 1px solid #cbd5e1; color: #334155; padding: 8px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-admin:hover { background: #e2e8f0; }
        .btn-full { grid-column: span 2; background: #3b82f6; color: white; border: none; }

        /* --- KDS & Pickup --- */
        #kitchen-app { display: none; height: 100%; width: 100%; flex-direction: column; background: #111827; color: white; padding: 20px; }
        #pickup-app { display: none; height: 100%; width: 100%; flex-direction: column; background: #0f172a; color: white; padding: 20px; }
        
        .screen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #334155; }
        .screen-title { font-size: 2rem; font-weight: bold; }
        .ticket-container, .pickup-grid { display: flex; flex-wrap: wrap; gap: 20px; overflow-y: auto; align-content: flex-start; flex: 1; }
        
        .ticket { background: #1f2937; width: 260px; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; border-top: 6px solid #6b7280; box-shadow: 0 10px 20px rgba(0,0,0,0.3); animation: popIn 0.3s; }
        .ticket-head { padding: 12px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; font-weight: bold; font-size: 1.5rem; color: #facc15; }
        .ticket-body { padding: 15px; flex: 1; font-size: 1.2rem; }
        .ticket-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #374151; padding-bottom: 4px; }
        .btn-done { width: 100%; padding: 15px; background: var(--success); color: white; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        .pickup-card { background: white; color: #0f172a; width: 300px; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: slideUp 0.5s; }
        .pickup-head { background: #f59e0b; color: black; padding: 20px; font-size: 3.5rem; font-weight: 900; text-align: center; letter-spacing: 2px; }
        .pickup-body { padding: 20px; flex: 1; font-size: 1.3rem; }
        .btn-picked { width: 100%; padding: 20px; background: #1e293b; color: white; border: none; font-weight: bold; font-size: 1.4rem; cursor: pointer; }

        /* --- Modals & Utils --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; font-size: 1.5rem; cursor: pointer; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: #f1f5f9; padding: 10px; text-align: left; }
        .data-table td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; }
        .toast { background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 50px; margin-top: 10px; animation: fade 3s forwards; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade { 0% { opacity: 0; transform: translateY(20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; } }
        
        .border-food { border-top-color: var(--color-food) !important; }
        .border-drink { border-top-color: var(--color-drink) !important; }
    </style>
</head>
<body>

    <div id="role-selection-screen">
        <div class="landing-title">ğŸª åœ’éŠæœƒ POS (é›²ç«¯ç‰ˆ)</div>
        <div class="role-grid">
            <div class="role-card role-full-width" onclick="selectRole('cashier')">
                <div class="role-icon">ğŸ’°</div>
                <div class="role-name">ç¸½å‹™æ”¶éŠ€å°</div>
            </div>
            <div class="role-card" onclick="selectRole('food')" style="background: linear-gradient(to right, #ea580c, #c2410c);">
                <div class="role-icon">ğŸ”</div>
                <div class="role-name">é£Ÿç‰©çµ„å»šæˆ¿</div>
            </div>
            <div class="role-card" onclick="selectRole('drink')" style="background: linear-gradient(to right, #0284c7, #0369a1);">
                <div class="role-icon">ğŸ¥¤</div>
                <div class="role-name">é£²æ–™çµ„å§å°</div>
            </div>
            <div class="role-card role-pickup" onclick="selectRole('pickup')">
                <div class="role-icon">ğŸ±</div>
                <div class="role-name">å‡ºé¤å£ (å«è™Ÿ)</div>
            </div>
        </div>
    </div>

    <div id="cashier-app">
        <div class="pos-layout">
            <div class="menu-area">
                <div class="category-bar">
                    <button class="cat-btn active" onclick="filterMenu('All')" data-group="All">å…¨éƒ¨</button>
                    <button class="cat-btn" onclick="filterMenu('é£Ÿç‰©çµ„')" data-group="é£Ÿç‰©çµ„">ğŸ” é£Ÿç‰©çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('é£²æ–™çµ„')" data-group="é£²æ–™çµ„">ğŸ¥¤ é£²æ–™çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('éŠæˆ²çµ„')" data-group="éŠæˆ²çµ„">ğŸ¯ éŠæˆ²çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('å‹•æ¼«çµ„')" data-group="å‹•æ¼«çµ„">ğŸ å‹•æ¼«çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('History')" data-group="History">ğŸ“œ æ­·å²ç´€éŒ„</button>
                </div>
                <div id="main-content-area" style="flex:1; overflow:hidden; display:flex;">
                    <div class="product-grid" id="menu-container"></div>
                </div>
            </div>

            <div class="cart-area">
                <div class="cart-header">
                    <h3 style="margin:0">ğŸ›’ è¨‚å–®æ˜ç´°</h3>
                    <button onclick="clearCart()" style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold;">æ¸…ç©º</button>
                </div>
                <div class="cart-items" id="cart-container"></div>
                <div class="control-panel">
                    <div class="price-row">
                        <span>ç¸½è¨ˆ</span>
                        <span style="color:var(--primary)" id="total-amount">$0</span>
                    </div>
                    <input type="number" id="pay-amount" class="input-pay" placeholder="å¯¦æ”¶" oninput="calculateChange()">
                    <div style="text-align:right; margin-bottom:15px; color:#64748b;">æ‰¾é›¶: <span id="change-amount" style="font-weight:bold">$0</span></div>
                    
                    <button class="btn-checkout" onclick="checkout()">âœ… çµå¸³ (å‡ºå–®)</button>

                    <div class="admin-panel">
                        <div class="admin-title">ç®¡ç†å¾Œå° (é›²ç«¯é€£ç·šä¸­)</div>
                        <div class="admin-grid">
                            <button class="btn-admin" onclick="openMenuEditor()">âš™ï¸ èœå–®</button>
                            <button class="btn-admin" onclick="showProfitAnalysis()">ğŸ’° å¸³å‹™</button>
                            <div style="grid-column: span 2; display:flex; gap:5px;">
                                <select id="export-target" style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                                    <option value="All">ä¸‹è¼‰ å…¨ç­ç¸½å¸³</option>
                                    <option value="é£Ÿç‰©çµ„">ä¸‹è¼‰ é£Ÿç‰©çµ„å ±è¡¨</option>
                                    <option value="é£²æ–™çµ„">ä¸‹è¼‰ é£²æ–™çµ„å ±è¡¨</option>
                                </select>
                                <button class="btn-admin btn-full" style="flex:0.5; grid-column:auto;" onclick="downloadSmartCSV()">ğŸ“¥</button>
                            </div>
                            <button class="btn-admin" onclick="location.reload()" style="background:#fff1f2; color:#be123c; border-color:#fda4af;">ğŸ”™ ç™»å‡º</button>
                            <button class="btn-admin" onclick="resetAllData()" style="background:#f1f5f9; color:#64748b;">âš ï¸ é›²ç«¯é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kitchen-app">
        <div class="screen-header">
            <div class="screen-title"><span id="kitchen-icon"></span> <span id="kitchen-text">å»šæˆ¿çœ‹æ¿</span></div>
            <div id="kitchen-clock" style="font-size:1.5rem; opacity:0.7;">00:00</div>
        </div>
        <div class="ticket-container" id="kitchen-orders"></div>
        <button onclick="location.reload()" style="position:fixed; bottom:20px; left:20px; padding:10px 20px; background:rgba(255,255,255,0.2); color:white; border:none; border-radius:50px; cursor:pointer;">ğŸ”™</button>
    </div>

    <div id="pickup-app">
        <div class="screen-header" style="justify-content:center; border-bottom:none;">
            <div class="screen-title" style="color:#f59e0b; font-size:3.5rem;">ğŸ± è«‹ å– é¤</div>
        </div>
        <div class="pickup-grid" id="pickup-orders"></div>
        <button onclick="location.reload()" style="position:fixed; bottom:20px; left:20px; padding:10px 20px; background:rgba(255,255,255,0.2); color:white; border:none; border-radius:50px; cursor:pointer;">ğŸ”™</button>
    </div>

    <div id="toast-box"></div>

    <div id="menu-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMenuEditor()">&times;</span>
            <h2>âš™ï¸ ç·¨è¼¯èœå–®</h2>
            <button onclick="addNewProductRow()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; margin-bottom:10px;">â• æ–°å¢</button>
            <div style="max-height:60vh; overflow-y:auto;">
                <table class="data-table">
                    <thead><tr><th>çµ„åˆ¥</th><th>åç¨±</th><th>åƒ¹æ ¼ (0=è‡ªè¨‚)</th><th></th></tr></thead>
                    <tbody id="menu-editor-body"></tbody>
                </table>
            </div>
            <button onclick="saveMenuChanges()" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:8px; margin-top:15px; cursor:pointer; font-weight:bold;">å„²å­˜è®Šæ›´ (åŒæ­¥è‡³é›²ç«¯)</button>
        </div>
    </div>

    <div id="profit-analysis-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideProfitAnalysis()">&times;</span>
            <h2>ğŸ’° æç›Šè¡¨ & è¨˜å¸³</h2>
            <div id="summary-cards" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px; text-align:center;"></div>
            <table class="data-table">
                <thead><tr><th>çµ„åˆ¥</th><th>ç‡Ÿæ”¶</th><th>æˆæœ¬ (é»æ“Šè¨˜å¸³)</th><th>æ·¨åˆ©</th></tr></thead>
                <tbody id="group-profit-body" style="text-align:center;"></tbody>
            </table>
        </div>
    </div>

    <div id="expense-manager-modal" class="modal" style="z-index:3100;">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeExpenseManager()">&times;</span>
            <h3>ğŸ“ <span id="expense-modal-title"></span> æ”¯å‡ºæ˜ç´°</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="ex-buyer" placeholder="ä»£å¢Šäºº" style="flex:1; padding:8px;">
                <input id="ex-note" placeholder="é …ç›®" style="flex:1; padding:8px;">
                <input id="ex-amt" type="number" placeholder="$" style="width:70px; padding:8px;">
                <button onclick="addExpense()" style="background:var(--warning); border:none; width:40px; cursor:pointer;">â•</button>
            </div>
            <table class="data-table"><tbody id="expense-list-body"></tbody></table>
            <div style="text-align:right; margin-top:10px; font-weight:bold;">ç¸½æ”¯å‡º: $<span id="expense-total-display">0</span></div>
        </div>
    </div>

    <script type="module">
        // --- 1. å¼•å…¥ Firebase SDK (CDN ç‰ˆæœ¬) ---
        // æ³¨æ„ï¼šé€™è£¡æ”¹æˆäº† CDN ç¶²å€ï¼Œé€™æ¨£æ‰èƒ½åœ¨ç€è¦½å™¨ç›´æ¥åŸ·è¡Œ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove, runTransaction } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
        // --- 2. ä½ çš„ Firebase è¨­å®š (å·²å¡«å…¥) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDcB7xlQfBmD97kOjc_ZMvnCkNbR5gS0Q",
            authDomain: "myposschoolfair.firebaseapp.com",
            databaseURL: "https://myposschoolfair-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myposschoolfair",
            storageBucket: "myposschoolfair.firebasestorage.app",
            messagingSenderId: "1003987181938",
            appId: "1:1003987181938:web:b9e2bdcdd52b369301bdeb"
        };
    
        // --- 3. åˆå§‹åŒ– Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const defaultProducts = [
            { id: 101, group: "é£Ÿç‰©çµ„", name: "éº»è¾£é´¨è¡€", price: 60 },
            { id: 102, group: "é£Ÿç‰©çµ„", name: "é´¨è¡€æ³¡éºµ", price: 80 },
            { id: 201, group: "é£²æ–™çµ„", name: "çå¥¶", price: 35 },
            { id: 301, group: "éŠæˆ²çµ„", name: "å„ç¨®éŠæˆ²", price: 30 },
            { id: 401, group: "å‹•æ¼«çµ„", name: "å‹•æ¼«/å‘¨é‚Š", price: 0 },
        ];
        const groupColors = { "é£Ÿç‰©çµ„": "#f97316", "é£²æ–™çµ„": "#0ea5e9", "éŠæˆ²çµ„": "#8b5cf6", "å‹•æ¼«çµ„": "#ec4899" };
        
        let products = [];
        let salesHistory = [];
        let expenseRecords = [];
        let dailyCount = 0;
        
        // æœ¬åœ°æš«å­˜
        let cart = [];
        let currentRole = '';
        let currentFilter = 'All';
        let currentEditingGroup = '';
    
        // --- 4. ç›£è½é›²ç«¯è³‡æ–™ ---
        const menuRef = ref(db, 'menu');
        const salesRef = ref(db, 'sales');
        const expensesRef = ref(db, 'expenses');
        const countRef = ref(db, 'dailyCount');
    
        // ç›£è½èœå–®
        onValue(menuRef, (snapshot) => {
            const data = snapshot.val();
            products = data ? Object.values(data) : defaultProducts;
            if (!data) set(menuRef, defaultProducts); // åˆå§‹åŒ–
            if (currentRole === 'cashier') renderMenu();
        });
    
        // ç›£è½è¨‚å–®
        onValue(salesRef, (snapshot) => {
            const data = snapshot.val();
            salesHistory = data ? Object.values(data) : [];
            refreshUI();
        });
    
        // ç›£è½æ”¯å‡º
        onValue(expensesRef, (snapshot) => {
            const data = snapshot.val();
            expenseRecords = data ? Object.values(data) : [];
            if(document.getElementById('profit-analysis-modal').style.display === 'flex') updateProfit();
        });
    
        // ç›£è½æµæ°´è™Ÿ
        onValue(countRef, (snapshot) => {
            dailyCount = snapshot.val() || 0;
        });
    
        window.refreshUI = function() {
            if(currentRole === 'food' || currentRole === 'drink') renderKitchen();
            if(currentRole === 'pickup') renderPickup();
            if(currentRole === 'cashier' && currentFilter === 'History') renderHistory();
        }
    
        // --- å…¨åŸŸå‡½å¼ç¶å®š ---
        window.selectRole = function(role) {
            currentRole = role;
            document.getElementById('role-selection-screen').style.display = 'none';
            if (role === 'cashier') {
                document.getElementById('cashier-app').style.display = 'block';
                renderMenu();
            } else if (role === 'pickup') {
                document.getElementById('pickup-app').style.display = 'flex';
                renderPickup();
            } else {
                document.getElementById('kitchen-app').style.display = 'flex';
                document.getElementById('kitchen-icon').innerText = role === 'food' ? 'ğŸ”' : 'ğŸ¥¤';
                document.getElementById('kitchen-text').innerText = role === 'food' ? 'é£Ÿç‰©çµ„' : 'é£²æ–™çµ„';
                renderKitchen();
            }
        };
    
        window.filterMenu = function(group) {
            currentFilter = group;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.cat-btn[data-group="${group}"]`).classList.add('active');
            
            const mainArea = document.getElementById('main-content-area');
            const historyList = document.getElementById('history-list');
            const menuContainer = document.getElementById('menu-container');
    
            if(group === 'History') {
                menuContainer.style.display = 'none';
                if(!historyList) {
                    const d = document.createElement('div'); d.id = 'history-list'; 
                    d.style.cssText = "flex:1; overflow-y:auto; padding-bottom:20px;";
                    mainArea.appendChild(d);
                }
                renderHistory();
            } else {
                menuContainer.style.display = 'grid';
                if(historyList) historyList.remove();
                renderMenu();
            }
        };
    
        window.addToCart = function(p) {
            let price = p.price;
            if(price === 0) {
                const input = prompt("è«‹è¼¸å…¥é‡‘é¡:", ""); if(!input) return;
                price = parseInt(input); if(isNaN(price)||price<=0) { showToast("é‡‘é¡éŒ¯èª¤"); return; }
            }
            const item = JSON.parse(JSON.stringify(p));
            item.price = price;
            const exist = cart.find(i => i.id === item.id && i.price === price);
            if(exist) exist.qty++; else { item.qty = 1; cart.push(item); }
            renderCart();
        };
    
        function renderMenu() {
            const container = document.getElementById('menu-container'); container.innerHTML = '';
            products.forEach(p => {
                if(currentFilter !== 'All' && currentFilter !== 'History' && p.group !== currentFilter) return;
                const div = document.createElement('div');
                div.className = 'product-card'; div.style.borderLeftColor = groupColors[p.group] || '#ccc';
                const price = p.price === 0 ? 'è‡ªè¨‚' : `$${p.price}`;
                div.innerHTML = `<div><span class="badge" style="background:${groupColors[p.group]||'#999'}">${p.group}</span><div class="product-name">${p.name}</div></div><div class="product-price">${price}</div>`;
                div.onclick = () => window.addToCart(p);
                container.appendChild(div);
            });
        }
    
        window.renderCart = function() {
            const container = document.getElementById('cart-container');
            if(cart.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#94a3b8; margin-top:50px;">ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>`;
                document.getElementById('total-amount').innerText = '$0';
                window.calculateChange(); return;
            }
            container.innerHTML = '';
            let total = 0;
            cart.forEach((item, idx) => {
                total += item.price * item.qty;
                container.innerHTML += `<div class="cart-item"><div><b>${item.name}</b><small>x${item.qty}</small></div><div style="display:flex;align-items:center;gap:10px;"><span>$${item.price*item.qty}</span><button class="btn-remove" onclick="window.removeFromCart(${idx})">Ã—</button></div></div>`;
            });
            document.getElementById('total-amount').innerText = `$${total}`;
            window.calculateChange();
        };
    
        window.removeFromCart = function(idx) { cart.splice(idx,1); renderCart(); };
        window.clearCart = function() { cart=[]; document.getElementById('pay-amount').value=''; renderCart(); };
        window.calculateChange = function() {
            const t = parseInt(document.getElementById('total-amount').innerText.replace('$',''));
            const p = parseInt(document.getElementById('pay-amount').value) || 0;
            const el = document.getElementById('change-amount');
            el.innerText = (p - t) >= 0 ? `$${p - t}` : "$0";
        };
    
        // --- çµå¸³ (ä½¿ç”¨ Transaction ç¢ºä¿æµæ°´è™Ÿæ­£ç¢º) ---
        window.checkout = function() {
            const t = parseInt(document.getElementById('total-amount').innerText.replace('$',''));
            if(t === 0) { showToast("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
    
            runTransaction(countRef, (currentCount) => {
                return (currentCount || 0) + 1;
            }).then((result) => {
                if (result.committed) {
                    const newCount = result.snapshot.val();
                    const displayId = String(newCount).padStart(3, '0');
                    const hasFood = cart.some(i => i.group === 'é£Ÿç‰©çµ„');
                    const hasDrink = cart.some(i => i.group === 'é£²æ–™çµ„');
                    
                    const newOrderRef = push(salesRef);
                    const record = {
                        dbKey: newOrderRef.key,
                        orderId: Date.now(),
                        displayId: displayId,
                        time: new Date().toLocaleTimeString('en-US', {hour12:false, hour:"2-digit", minute:"2-digit"}),
                        total: t,
                        items: cart,
                        foodStatus: hasFood ? 'pending' : 'none',
                        drinkStatus: hasDrink ? 'pending' : 'none'
                    };
    
                    set(newOrderRef, record);
                    showToast(`å–®è™Ÿ #${displayId} çµå¸³æˆåŠŸï¼`, "success");
                    window.clearCart();
                }
            });
        };
    
        window.renderHistory = function() {
            const container = document.getElementById('history-list'); if(!container) return;
            container.innerHTML = '';
            [...salesHistory].reverse().forEach(r => {
                const items = r.items ? r.items.map(i=>`${i.name} x${i.qty}`).join(', ') : '';
                const idDisplay = r.displayId || '---';
                container.innerHTML += `<div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; border-left:5px solid #64748b; display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="font-weight:bold;font-size:1.1rem;">å–®è™Ÿ #${idDisplay} <span style="font-weight:normal;color:#64748b;font-size:0.9rem;">${r.time}</span></div><div style="font-size:0.9rem;margin-top:5px;">${items}</div></div>
                    <div style="text-align:right;"><div style="font-weight:bold;color:var(--primary);margin-bottom:5px;">$${r.total}</div><button onclick="window.deleteOrder('${r.dbKey}')" style="border:1px solid #ef4444;color:#ef4444;background:none;padding:4px 8px;border-radius:4px;cursor:pointer;">åˆªé™¤</button></div>
                </div>`;
            });
        };
        window.deleteOrder = function(key) { 
            if(confirm("ç¢ºå®šåˆªé™¤? é€™æœƒå¾æ‰€æœ‰è£ç½®ç§»é™¤æ­¤å–®")) remove(ref(db, `sales/${key}`));
        };
    
        window.renderKitchen = function() {
            const container = document.getElementById('kitchen-orders');
            const target = currentRole === 'food' ? 'é£Ÿç‰©çµ„' : 'é£²æ–™çµ„';
            let html = '';
            salesHistory.forEach(o => {
                let status = target === 'é£Ÿç‰©çµ„' ? o.foodStatus : o.drinkStatus;
                if(status !== 'pending') return;
                const items = o.items ? o.items.filter(i => i.group === target) : [];
                if(items.length > 0) {
                    const rows = items.map(i => `<div class="ticket-item"><span>${i.name}</span><b>x${i.qty}</b></div>`).join('');
                    const border = target === 'é£Ÿç‰©çµ„' ? 'border-food' : 'border-drink';
                    const idDisplay = o.displayId || '---';
                    html += `<div class="ticket ${border}"><div class="ticket-head"><span>#${idDisplay}</span><span>${o.time}</span></div><div class="ticket-body">${rows}</div><button class="btn-done" onclick="window.doneKitchen('${o.dbKey}','${target}')">âœ… å®Œæˆ</button></div>`;
                }
            });
            container.innerHTML = html || '<div style="width:100%;text-align:center;margin-top:100px;color:#64748b;font-size:1.2rem;">ğŸ‘¨â€ğŸ³ æš«ç„¡è¨‚å–®</div>';
        };
        window.doneKitchen = function(key, grp) {
            const updates = {};
            if(grp==='é£Ÿç‰©çµ„') updates[`sales/${key}/foodStatus`] = 'ready';
            if(grp==='é£²æ–™çµ„') updates[`sales/${key}/drinkStatus`] = 'ready';
            update(ref(db), updates);
        };
    
        window.renderPickup = function() {
            const container = document.getElementById('pickup-orders');
            let html = '';
            salesHistory.forEach(o => {
                if(!o.items) return;
                const relevantItems = o.items.filter(i => i.group === 'é£Ÿç‰©çµ„' || i.group === 'é£²æ–™çµ„');
                if(relevantItems.length === 0) return;
                const fDone = !o.items.some(i=>i.group==='é£Ÿç‰©çµ„') || o.foodStatus==='ready';
                const dDone = !o.items.some(i=>i.group==='é£²æ–™çµ„') || o.drinkStatus==='ready';
                const isPicked = (o.items.some(i=>i.group==='é£Ÿç‰©çµ„') && o.foodStatus==='picked') || (o.items.some(i=>i.group==='é£²æ–™çµ„') && o.drinkStatus==='picked');
                if(fDone && dDone && !isPicked) {
                    const rows = relevantItems.map(i => `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #e2e8f0;margin-bottom:5px;"><span>${i.name}</span><span>x${i.qty}</span></div>`).join('');
                    const idDisplay = o.displayId || '---';
                    html += `<div class="pickup-card"><div class="pickup-head">#${idDisplay}</div><div class="pickup-body">${rows}</div><button class="btn-picked" onclick="window.pickupDone('${o.dbKey}')">ğŸ‘Œ å·²å–é¤</button></div>`;
                }
            });
            container.innerHTML = html || '<div style="width:100%;text-align:center;margin-top:100px;color:#64748b;font-size:1.5rem;">ğŸµ æš«ç„¡å¾…å–è¨‚å–®</div>';
        };
        window.pickupDone = function(key) {
            const order = salesHistory.find(o => o.dbKey === key);
            if(!order) return;
            const updates = {};
            if(order.foodStatus==='ready') updates[`sales/${key}/foodStatus`] = 'picked';
            if(order.drinkStatus==='ready') updates[`sales/${key}/drinkStatus`] = 'picked';
            update(ref(db), updates);
        };
    
        window.addExpense = function() {
            const b=document.getElementById('ex-buyer').value, n=document.getElementById('ex-note').value, a=parseInt(document.getElementById('ex-amt').value);
            if(b&&n&&!isNaN(a)) {
                push(expensesRef, {group: currentEditingGroup, buyer:b, note:n, amount:a});
                document.getElementById('ex-amt').value=''; 
            }
        };
        window.renderExpense = function() {
            const l=expenseRecords.filter(e=>e.group=== currentEditingGroup);
            document.getElementById('expense-list-body').innerHTML=l.map(e=>`<tr><td>${e.buyer}</td><td>${e.note}</td><td>$${e.amount}</td><td></td></tr>`).join('');
            document.getElementById('expense-total-display').innerText=l.reduce((s,e)=>s+e.amount,0);
        };
        window.openExpense = function(g) { 
            currentEditingGroup=g; document.getElementById('expense-modal-title').innerText=g; 
            window.renderExpense(); document.getElementById('expense-manager-modal').style.display='flex'; 
        };
        window.closeExpenseManager = function() { document.getElementById('expense-manager-modal').style.display='none'; };
    
        window.showProfitAnalysis = function() { document.getElementById('profit-analysis-modal').style.display='flex'; updateProfit(); }
        window.hideProfitAnalysis = function() { document.getElementById('profit-analysis-modal').style.display='none'; }
        window.updateProfit = function() {
            let r={}, c={}, tr=0, tc=0;
            ["é£Ÿç‰©çµ„", "é£²æ–™çµ„", "éŠæˆ²çµ„", "å‹•æ¼«çµ„"].forEach(g=>{ r[g]=0; c[g]=expenseRecords.filter(e=>e.group===g).reduce((s,e)=>s+e.amount,0); });
            salesHistory.forEach(o=>o.items.forEach(i=>{ if(r[i.group]!==undefined) r[i.group]+=i.price*i.qty; }));
            let h='';
            ["é£Ÿç‰©çµ„", "é£²æ–™çµ„", "éŠæˆ²çµ„", "å‹•æ¼«çµ„"].forEach(g=>{
                tr+=r[g]; tc+=c[g]; const p=r[g]-c[g];
                h+=`<tr><td>${g}</td><td>$${r[g]}</td><td><button onclick="openExpense('${g}')" style="background:#f1f5f9;border:1px solid #ddd;padding:5px 10px;cursor:pointer;border-radius:6px;">$${c[g]} âœ</button></td><td style="color:${p>=0?'var(--success)':'var(--danger)'};font-weight:bold;">$${p}</td></tr>`;
            });
            document.getElementById('group-profit-body').innerHTML=h;
            document.getElementById('summary-cards').innerHTML=`<div class="stat-card" style="background:#dbeafe">ç‡Ÿæ”¶<br><b style="font-size:1.5rem">$${tr}</b></div><div class="stat-card" style="background:#fef3c7">æˆæœ¬<br><b style="font-size:1.5rem">$${tc}</b></div><div class="stat-card" style="background:#dcfce7">æ·¨åˆ©<br><b style="font-size:1.5rem;color:${(tr-tc)>=0?'var(--success)':'var(--danger)'}">$${tr-tc}</b></div>`;
        };
    
        window.downloadSmartCSV = function() {
            if(salesHistory.length===0){showToast("ç„¡è³‡æ–™");return}
            const t=document.getElementById('export-target').value;
            let c="\uFEFFæ™‚é–“,å–®è™Ÿ,çµ„åˆ¥,å“é …,æ•¸é‡,å–®åƒ¹,å°è¨ˆ\n";
            salesHistory.forEach(r=>r.items.forEach(i=>{
                if(t==='All'||i.group===t) c+=`${r.time},${r.displayId},${i.group},${i.name},${i.qty},${i.price},${i.price*i.qty}\n`;
            }));
            const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([c],{type:"text/csv;charset=utf-8;"})); l.download=`ç‡Ÿæ”¶_${t}.csv`; document.body.appendChild(l); l.click(); document.body.removeChild(l);
        }
        
        window.showToast = function(msg) {
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            div.className = 'toast'; div.innerText = msg;
            box.appendChild(div); setTimeout(() => div.remove(), 3000);
        }
    
        window.openMenuEditor = function() {
            document.getElementById('menu-editor-modal').style.display='flex';
            const b = document.getElementById('menu-editor-body'); b.innerHTML='';
            products.forEach(p => addEditorRow(p));
        }
        window.closeMenuEditor = function() { document.getElementById('menu-editor-modal').style.display='none'; }
        window.addNewProductRow = function() { addEditorRow(); }
        
        function addEditorRow(p=null) {
            const b=document.getElementById('menu-editor-body'); const r=document.createElement('tr');
            const availableGroups = ["é£Ÿç‰©çµ„", "é£²æ–™çµ„", "éŠæˆ²çµ„", "å‹•æ¼«çµ„"];
            const opts = availableGroups.map(g=>`<option value="${g}" ${p&&p.group===g?'selected':''}>${g}</option>`).join('');
            r.innerHTML=`<td><select class="e-g" style="padding:5px;border:1px solid #ddd;border-radius:4px;">${opts}</select></td>
            <td><input class="e-n" value="${p?p.name:''}" style="padding:5px;border:1px solid #ddd;border-radius:4px;"></td>
            <td><input class="e-p" type="number" value="${p?p.price:0}" style="padding:5px;border:1px solid #ddd;border-radius:4px;"></td>
            <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;cursor:pointer;">ğŸ—‘ï¸</button></td>`;
            b.appendChild(r);
        }
        
        window.saveMenuChanges = function() {
            const rs=document.querySelectorAll('#menu-editor-body tr'); const np=[];
            rs.forEach(r=>{
                const n=r.querySelector('.e-n').value.trim();
                if(n) np.push({id:Date.now()+Math.random(), group:r.querySelector('.e-g').value, name:n, price:parseInt(r.querySelector('.e-p').value)||0});
            });
            set(menuRef, np);
            window.closeMenuEditor(); showToast("èœå–®å·²æ›´æ–° (æ‰€æœ‰è£ç½®åŒæ­¥)");
        }
    
        window.resetAllData = function() { 
            if(prompt("è«‹è¼¸å…¥ 'RESET' ç¢ºèªæ¸…é™¤é›²ç«¯æ‰€æœ‰è³‡æ–™") === 'RESET'){
                remove(ref(db));
                location.reload();
            } 
        }
    
        setInterval(() => {
            const now = new Date();
            const t = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
            if(document.getElementById('kitchen-clock')) document.getElementById('kitchen-clock').innerText = t;
        }, 1000);
    
    </script>
</body>
</html>