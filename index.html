<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ’éŠæœƒ POS Pro (è²¡å‹™å‡ç´šç‰ˆ)</title>
    <style>
        /* --- æ¨£å¼è¨­å®š (ä¿æŒåŸæ¨£ï¼Œé‡å°å ±è¡¨å€å¡Šå¾®èª¿) --- */
        :root { --primary: #4f46e5; --secondary: #64748b; --bg-body: #f1f5f9; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --radius: 12px; --color-food: #f97316; --color-drink: #0ea5e9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); height: 100vh; overflow: hidden; color: #1e293b; }
        button, select, input { font-family: inherit; outline: none; }

        /* Role Selection */
        #role-selection-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .landing-title { font-size: 3.5rem; font-weight: 800; color: white; margin-bottom: 40px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .role-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 90%; max-width: 700px; }
        .role-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; text-align: center; cursor: pointer; color: white; transition: 0.3s; }
        .role-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.2); }
        .role-icon { font-size: 3rem; margin-bottom: 10px; display: block;}
        .role-name { font-size: 1.4rem; font-weight: bold; }

        /* POS Layout */
        #cashier-app { display: none; height: 100%; width: 100%; }
        .pos-layout { display: flex; height: 100%; }
        .menu-area { flex: 7; display: flex; flex-direction: column; padding: 15px; gap: 10px; }
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .cat-btn { background: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: 600; color: var(--secondary); cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cat-btn.active { background: #334155; color: white; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; overflow-y: auto; padding-bottom: 20px; align-content: flex-start; }
        .product-card { background: white; border-radius: var(--radius); padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; height: 110px; border-left: 5px solid #ccc; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .product-card:active { transform: scale(0.95); }
        .product-card.sold-out { opacity: 0.6; filter: grayscale(1); background: #e2e8f0; cursor: not-allowed; }
        .product-card.sold-out::after { content: "å®Œå”®"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: #ef4444; font-size: 2rem; font-weight: 900; border: 3px solid #ef4444; padding: 5px 10px; border-radius: 8px; }
        .product-price { font-size: 1.2rem; font-weight: 800; color: var(--primary); text-align: right; }

        /* Cart & Admin */
        .cart-area { flex: 3; background: white; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.05); min-width: 360px; z-index: 10; }
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-item { margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .cart-item-top { display: flex; justify-content: space-between; align-items: center; }
        .control-panel { padding: 20px; background: white; border-top: 1px solid #e2e8f0; }
        .btn-checkout { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.3rem; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        
        .admin-panel { background: #f1f5f9; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1; }
        .admin-title { font-size: 0.85rem; font-weight: bold; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-admin { background: white; border: 1px solid #cbd5e1; color: #334155; padding: 8px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-full { grid-column: span 2; background: #3b82f6; color: white; border: none; }

        /* Kitchen & Pickup */
        #kitchen-app, #pickup-app { display: none; height: 100%; width: 100%; flex-direction: column; padding: 20px; color: white; }
        #kitchen-app { background: #111827; } #pickup-app { background: #0f172a; }
        .screen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #334155; }
        .kitchen-tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 50px; padding: 4px; }
        .k-tab { border: none; background: transparent; color: #94a3b8; padding: 8px 16px; border-radius: 40px; cursor: pointer; font-weight: bold; }
        .k-tab.active { background: white; color: #0f172a; }
        .ticket-container { display: flex; flex-wrap: wrap; gap: 20px; overflow-y: auto; align-content: flex-start; flex: 1; }
        .ticket { background: #1f2937; width: 260px; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; border-top: 6px solid #6b7280; animation: popIn 0.3s; }
        .ticket.history-mode { opacity: 0.8; border-top-color: #64748b !important; }
        .ticket-head { padding: 12px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; font-weight: bold; font-size: 1.5rem; color: #facc15; }
        .ticket-body { padding: 15px; flex: 1; font-size: 1.2rem; }
        .btn-done { width: 100%; padding: 15px; background: var(--success); color: white; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .btn-undo { width: 100%; padding: 15px; background: #475569; color: white; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .pickup-card { background: white; color: #0f172a; width: 300px; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.5s; }
        .pickup-head { background: #f59e0b; color: black; padding: 20px; font-size: 3.5rem; font-weight: 900; text-align: center; }
        .btn-picked { width: 100%; padding: 20px; background: #1e293b; color: white; border: none; font-weight: bold; font-size: 1.4rem; cursor: pointer; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; font-size: 1.5rem; cursor: pointer; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: #f1f5f9; padding: 10px; text-align: left; }
        .data-table td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; }
        .toast { background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 50px; margin-top: 10px; animation: fade 3s forwards; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="role-selection-screen">
        <div class="landing-title">ğŸª åœ’éŠæœƒ POS Pro</div>
        <div class="role-grid">
            <div class="role-card" style="grid-column: span 2; background: linear-gradient(to right, #4f46e5, #3b82f6);" onclick="selectRole('cashier')">
                <span class="role-icon">ğŸ’°</span> <span class="role-name">ç¸½å‹™æ”¶éŠ€å°</span>
            </div>
            <div class="role-card" style="background: linear-gradient(to right, #ea580c, #c2410c);" onclick="selectRole('food')">
                <span class="role-icon">ğŸ”</span> <span class="role-name">é£Ÿç‰©çµ„å»šæˆ¿</span>
            </div>
            <div class="role-card" style="background: linear-gradient(to right, #0284c7, #0369a1);" onclick="selectRole('drink')">
                <span class="role-icon">ğŸ¥¤</span> <span class="role-name">é£²æ–™çµ„å§å°</span>
            </div>
            <div class="role-card" style="grid-column: span 2; background: linear-gradient(to right, #f59e0b, #d97706);" onclick="selectRole('pickup')">
                <span class="role-icon">ğŸ±</span> <span class="role-name">å‡ºé¤å£ (å«è™Ÿ)</span>
            </div>
        </div>
        <div style="color:rgba(255,255,255,0.5); margin-top:20px;">æç¤ºï¼šæ”¶éŠ€å°é•·æŒ‰å•†å“å¯åˆ‡æ›å®Œå”®</div>
    </div>

    <div id="cashier-app">
        <div class="pos-layout">
            <div class="menu-area">
                <div class="category-bar">
                    <button class="cat-btn active" onclick="filterMenu('All')" data-group="All">å…¨éƒ¨</button>
                    <button class="cat-btn" onclick="filterMenu('é£Ÿç‰©çµ„')" data-group="é£Ÿç‰©çµ„">ğŸ” é£Ÿç‰©çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('é£²æ–™çµ„')" data-group="é£²æ–™çµ„">ğŸ¥¤ é£²æ–™çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('éŠæˆ²çµ„')" data-group="éŠæˆ²çµ„">ğŸ¯ éŠæˆ²çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('å‹•æ¼«çµ„')" data-group="å‹•æ¼«çµ„">ğŸ å‹•æ¼«çµ„</button>
                    <button class="cat-btn" onclick="filterMenu('History')" data-group="History">ğŸ“œ æ­·å²ç´€éŒ„</button>
                </div>
                <div id="main-content-area" style="flex:1; overflow:hidden; display:flex;">
                    <div class="product-grid" id="menu-container"></div>
                </div>
            </div>
            <div class="cart-area">
                <div class="cart-header"><h3>ğŸ›’ è¨‚å–®æ˜ç´°</h3><button onclick="clearCart()" style="color:var(--danger); background:none; border:none; cursor:pointer;">æ¸…ç©º</button></div>
                <div class="cart-items" id="cart-container"></div>
                <div class="control-panel">
                    <div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:bold; margin-bottom:10px;">
                        <span>ç¸½è¨ˆ</span><span id="total-amount" style="color:var(--primary)">$0</span>
                    </div>
                    <input type="number" id="pay-amount" class="input-pay" style="width:100%; padding:10px; margin-bottom:10px; text-align:right; font-size:1.1rem;" placeholder="å¯¦æ”¶" oninput="calculateChange()">
                    <div style="text-align:right; margin-bottom:10px; color:#64748b;">æ‰¾é›¶: <span id="change-amount" style="font-weight:bold">$0</span></div>
                    <button class="btn-checkout" onclick="checkout()">âœ… çµå¸³ (å‡ºå–®)</button>
                    
                    <div class="admin-panel">
                        <div class="admin-title">å¾Œå°ç®¡ç†</div>
                        <div class="admin-grid">
                            <button class="btn-admin" onclick="openMenuEditor()">âš™ï¸ èœå–®/åº«å­˜</button>
                            <button class="btn-admin" onclick="showProfitAnalysis()">ğŸ’° æç›Š/è¨˜å¸³</button>
                            <div style="grid-column: span 2; display:flex; gap:5px;">
                                <select id="export-target" style="flex:1; border-radius:6px; border:1px solid #cbd5e1;">
                                    <option value="All">ä¸‹è¼‰ ç¸½ç‡Ÿæ”¶è¡¨</option>
                                    <option value="é£Ÿç‰©çµ„">ä¸‹è¼‰ é£Ÿç‰©çµ„ç‡Ÿæ”¶</option>
                                    <option value="é£²æ–™çµ„">ä¸‹è¼‰ é£²æ–™çµ„ç‡Ÿæ”¶</option>
                                </select>
                                <button class="btn-admin" onclick="downloadSmartCSV()">ğŸ“¥ åŒ¯å‡º</button>
                            </div>
                            <button class="btn-admin" onclick="location.reload()" style="background:#fff1f2; color:#be123c;">ğŸ”™ ç™»å‡º</button>
                            <button class="btn-admin" onclick="resetAllData()" style="background:#f1f5f9; color:#64748b;">âš ï¸ é›²ç«¯é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kitchen-app">
        <div class="screen-header">
            <div style="font-size:2rem; font-weight:bold;"><span id="kitchen-icon"></span> <span id="kitchen-text">å»šæˆ¿</span></div>
            <div class="kitchen-tabs">
                <button id="btn-k-pending" class="k-tab active" onclick="setKitchenMode('pending')">ğŸ”¥ å¾…è¾¦</button>
                <button id="btn-k-history" class="k-tab" onclick="setKitchenMode('history')">ğŸ“œ ç´€éŒ„</button>
            </div>
            <div id="kitchen-clock" style="font-size:1.5rem; opacity:0.7;"></div>
        </div>
        <div class="ticket-container" id="kitchen-orders"></div>
        <button onclick="location.reload()" style="position:fixed; bottom:20px; left:20px; padding:10px 20px; background:rgba(255,255,255,0.2); border-radius:50px; border:none; color:white; cursor:pointer;">ğŸ”™</button>
    </div>

    <div id="pickup-app">
        <div class="screen-header" style="justify-content:center; border-bottom:none;">
            <div style="color:#f59e0b; font-size:3.5rem; font-weight:bold;">ğŸ± è«‹ å– é¤</div>
        </div>
        <div class="ticket-container" id="pickup-orders" style="justify-content:center;"></div>
        <button onclick="location.reload()" style="position:fixed; bottom:20px; left:20px; padding:10px 20px; background:rgba(255,255,255,0.2); border-radius:50px; border:none; color:white; cursor:pointer;">ğŸ”™</button>
    </div>

    <div id="toast-box"></div>

    <div id="profit-analysis-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideProfitAnalysis()">&times;</span>
            <h2>ğŸ’° æç›Šè¡¨ & è¨˜å¸³ç³»çµ±</h2>
            <div id="summary-cards" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px; text-align:center;"></div>
            
            <table class="data-table">
                <thead><tr><th>çµ„åˆ¥</th><th>ç¸½ç‡Ÿæ”¶</th><th>ç¸½æˆæœ¬ (é»æ“Šè¨˜å¸³)</th><th>æ·¨åˆ©</th></tr></thead>
                <tbody id="group-profit-body" style="text-align:center;"></tbody>
            </table>

            <div style="margin-top:20px; text-align:right;">
                <button onclick="downloadExpenseCSV()" style="background:#64748b; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ“¥ ä¸‹è¼‰æ”¯å‡ºæ˜ç´°è¡¨</button>
            </div>
        </div>
    </div>

    <div id="expense-manager-modal" class="modal" style="z-index:3100;">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeExpenseManager()">&times;</span>
            <h3>ğŸ“ <span id="expense-modal-title"></span> æ”¯å‡ºæ˜ç´°</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="ex-buyer" placeholder="ä»£å¢Šäºº (å¦‚: ç‹å°æ˜)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <input id="ex-note" placeholder="é …ç›® (å¦‚: å†°å¡Š)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <input id="ex-amt" type="number" placeholder="$" style="width:70px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <button onclick="addExpense()" style="background:var(--warning); border:none; width:40px; cursor:pointer; border-radius:4px;">â•</button>
            </div>
            <table class="data-table">
                <thead><tr><th>ä»£å¢Šäºº</th><th>é …ç›®</th><th>é‡‘é¡</th><th></th></tr></thead>
                <tbody id="expense-list-body"></tbody>
            </table>
            <div style="text-align:right; margin-top:10px; font-weight:bold;">æ­¤çµ„ç¸½æ”¯å‡º: $<span id="expense-total-display">0</span></div>
        </div>
    </div>

    <div id="menu-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMenuEditor()">&times;</span>
            <h2>âš™ï¸ ç·¨è¼¯èœå–®</h2>
            <button onclick="addNewProductRow()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; margin-bottom:10px;">â• æ–°å¢å•†å“</button>
            <div style="max-height:60vh; overflow-y:auto;">
                <table class="data-table">
                    <thead><tr><th>ç‹€æ…‹</th><th>çµ„åˆ¥</th><th>åç¨±</th><th>åƒ¹æ ¼</th><th></th></tr></thead>
                    <tbody id="menu-editor-body"></tbody>
                </table>
            </div>
            <button onclick="saveMenuChanges()" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:8px; margin-top:15px; cursor:pointer; font-weight:bold;">å„²å­˜è®Šæ›´</button>
        </div>
    </div>

    <audio id="sound-checkout" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-kitchen" src="https://assets.mixkit.co/active_storage/sfx/571/571-preview.mp3"></audio>
    <audio id="sound-pickup" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove, runTransaction } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyBDcB7xlQfBmD97kOjc_ZMvnCkNbR5gS0Q",
            authDomain: "myposschoolfair.firebaseapp.com",
            databaseURL: "https://myposschoolfair-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myposschoolfair",
            storageBucket: "myposschoolfair.firebasestorage.app",
            messagingSenderId: "1003987181938",
            appId: "1:1003987181938:web:b9e2bdcdd52b369301bdeb"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    
        // é è¨­è³‡æ–™
        const defaultProducts = [
            { id: 101, group: "é£Ÿç‰©çµ„", name: "éº»è¾£é´¨è¡€", price: 60, soldOut: false },
            { id: 102, group: "é£Ÿç‰©çµ„", name: "é´¨è¡€æ³¡éºµ", price: 80, soldOut: false },
            { id: 201, group: "é£²æ–™çµ„", name: "çå¥¶", price: 35, soldOut: false },
            { id: 301, group: "éŠæˆ²çµ„", name: "å„ç¨®éŠæˆ²", price: 30, soldOut: false },
            { id: 401, group: "å‹•æ¼«çµ„", name: "å‹•æ¼«/å‘¨é‚Š", price: 0, soldOut: false },
        ];
        const groupColors = { "é£Ÿç‰©çµ„": "#f97316", "é£²æ–™çµ„": "#0ea5e9", "éŠæˆ²çµ„": "#8b5cf6", "å‹•æ¼«çµ„": "#ec4899" };
        
        // State
        let products = [];
        let salesHistory = [];
        let expenseRecords = [];
        let dailyCount = 0;
        let cart = [];
        let currentRole = '';
        let currentFilter = 'All';
        let currentEditingGroup = '';
        let kitchenViewMode = 'pending';
        let lastSalesLength = 0;

        // Refs
        const menuRef = ref(db, 'menu');
        const salesRef = ref(db, 'sales');
        const expensesRef = ref(db, 'expenses');
        const countRef = ref(db, 'dailyCount');
    
        const playSound = (id) => {
            const audio = document.getElementById(id);
            if(audio) { audio.currentTime = 0; audio.play().catch(e=>console.log("Audio play failed")); }
        };

        // --- Data Listeners ---
        onValue(menuRef, (snap) => {
            const data = snap.val();
            products = data ? Object.values(data) : defaultProducts;
            if(!data) set(menuRef, defaultProducts);
            if(currentRole === 'cashier') renderMenu();
        });
        onValue(salesRef, (snap) => {
            const data = snap.val();
            const newSales = data ? Object.values(data) : [];
            if(newSales.length > lastSalesLength && lastSalesLength > 0) {
                if(currentRole === 'food' || currentRole === 'drink') playSound('sound-kitchen');
                if(currentRole === 'pickup') playSound('sound-pickup');
            }
            lastSalesLength = newSales.length;
            salesHistory = newSales;
            refreshUI();
            if(document.getElementById('profit-analysis-modal').style.display === 'flex') updateProfit();
        });
        onValue(expensesRef, (snap) => {
            const data = snap.val();
            expenseRecords = data ? Object.values(data) : [];
            if(document.getElementById('profit-analysis-modal').style.display === 'flex') updateProfit();
        });
        onValue(countRef, (snap) => dailyCount = snap.val() || 0);

        window.refreshUI = function() {
            if(currentRole === 'food' || currentRole === 'drink') renderKitchen();
            if(currentRole === 'pickup') renderPickup();
            if(currentRole === 'cashier' && currentFilter === 'History') renderHistory();
        };

        // --- Role Selection ---
        window.selectRole = function(role) {
            if (role === 'cashier') {
                if (prompt("ğŸ”’ è«‹è¼¸å…¥ç¸½å‹™å¯†ç¢¼ï¼š") !== '1329') { alert("ğŸš« å¯†ç¢¼éŒ¯èª¤"); return; }
            }
            currentRole = role;
            document.getElementById('role-selection-screen').style.display = 'none';
            if (role === 'cashier') {
                document.getElementById('cashier-app').style.display = 'block';
                renderMenu();
            } else if (role === 'pickup') {
                document.getElementById('pickup-app').style.display = 'flex';
                renderPickup();
            } else {
                kitchenViewMode = 'pending';
                document.getElementById('btn-k-pending').classList.add('active');
                document.getElementById('btn-k-history').classList.remove('active');
                document.getElementById('kitchen-app').style.display = 'flex';
                document.getElementById('kitchen-icon').innerText = role === 'food' ? 'ğŸ”' : 'ğŸ¥¤';
                document.getElementById('kitchen-text').innerText = role === 'food' ? 'é£Ÿç‰©çµ„' : 'é£²æ–™çµ„';
                renderKitchen();
            }
        };

        // --- POS Logic ---
        window.filterMenu = function(g) {
            currentFilter = g;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.cat-btn[data-group="${g}"]`).classList.add('active');
            const mc = document.getElementById('menu-container');
            if(g === 'History') {
                mc.style.display = 'none';
                if(!document.getElementById('history-list')) {
                    const d = document.createElement('div'); d.id = 'history-list'; 
                    d.style.cssText = "flex:1; overflow-y:auto; padding-bottom:20px;";
                    document.getElementById('main-content-area').appendChild(d);
                }
                renderHistory();
            } else {
                mc.style.display = 'grid';
                const h = document.getElementById('history-list'); if(h) h.remove();
                renderMenu();
            }
        };

        let pressTimer;
        window.startLongPress = function(p) { pressTimer = window.setTimeout(() => toggleSoldOut(p), 800); };
        window.cancelLongPress = function() { window.clearTimeout(pressTimer); };
        window.toggleSoldOut = function(p) {
            if(confirm(`å°‡ã€Œ${p.name}ã€åˆ‡æ›ç‚º ${p.soldOut ? 'æœ‰è²¨' : 'å®Œå”®'}?`)) {
                const idx = products.findIndex(x => x.id === p.id);
                if(idx !== -1) {
                    const updated = [...products]; updated[idx].soldOut = !updated[idx].soldOut;
                    set(menuRef, updated);
                }
            }
        };

        window.addToCart = function(p) {
            if(p.soldOut) { showToast("âŒ å·²å®Œå”® (é•·æŒ‰å¯è§£é™¤)"); return; }
            let price = p.price;
            if(price === 0) {
                const input = prompt("è¼¸å…¥é‡‘é¡:", ""); if(!input) return;
                price = parseInt(input); if(isNaN(price)||price<=0) return;
            }
            const item = JSON.parse(JSON.stringify(p)); item.price = price; item.note = '';
            const exist = cart.find(i => i.id === item.id && i.price === price && i.note === item.note);
            if(exist) exist.qty++; else { item.qty = 1; cart.push(item); }
            renderCart();
        };

        window.addNoteToItem = function(idx) {
            const n = prompt("è¼¸å…¥å‚™è¨»:", cart[idx].note || "");
            if(n !== null) { cart[idx].note = n; renderCart(); }
        };

        function renderMenu() {
            const c = document.getElementById('menu-container'); c.innerHTML = '';
            products.forEach(p => {
                if(currentFilter !== 'All' && currentFilter !== 'History' && p.group !== currentFilter) return;
                const div = document.createElement('div');
                div.className = `product-card ${p.soldOut ? 'sold-out' : ''}`;
                div.style.borderLeftColor = groupColors[p.group] || '#ccc';
                div.onmousedown = () => window.startLongPress(p); div.onmouseup = () => window.cancelLongPress();
                div.ontouchstart = () => window.startLongPress(p); div.ontouchend = () => window.cancelLongPress();
                div.onclick = () => window.addToCart(p);
                div.innerHTML = `<div><span class="badge" style="background:${groupColors[p.group]||'#999'}">${p.group}</span><div class="product-name">${p.name}</div></div><div class="product-price">${p.price===0?'è‡ªè¨‚':'$'+p.price}</div>`;
                c.appendChild(div);
            });
        }

        window.renderCart = function() {
            const c = document.getElementById('cart-container');
            if(cart.length === 0) { c.innerHTML = `<div style="text-align:center;color:#94a3b8;margin-top:50px;">ğŸ›’ ç©ºç©ºå¦‚ä¹Ÿ</div>`; document.getElementById('total-amount').innerText = '$0'; window.calculateChange(); return; }
            c.innerHTML = ''; let total = 0;
            cart.forEach((i, idx) => {
                total += i.price * i.qty;
                const noteHtml = i.note ? `<div class="cart-note">ğŸ“ ${i.note}</div>` : `<div class="cart-note" style="opacity:0.5;">é»æ­¤åŠ å‚™è¨»...</div>`;
                c.innerHTML += `<div class="cart-item" onclick="addNoteToItem(${idx})"><div class="cart-item-top"><div><b>${i.name}</b> x${i.qty}</div><div><span>$${i.price*i.qty}</span> <button class="btn-remove" onclick="event.stopPropagation();removeFromCart(${idx})">Ã—</button></div></div>${noteHtml}</div>`;
            });
            document.getElementById('total-amount').innerText = `$${total}`;
            window.calculateChange();
        };

        window.removeFromCart = function(i) { cart.splice(i,1); renderCart(); };
        window.clearCart = function() { cart=[]; document.getElementById('pay-amount').value=''; renderCart(); };
        window.calculateChange = function() {
            const t = parseInt(document.getElementById('total-amount').innerText.replace('$',''));
            const p = parseInt(document.getElementById('pay-amount').value) || 0;
            document.getElementById('change-amount').innerText = (p-t)>=0 ? `$${p-t}` : "$0";
        };

        window.checkout = function() {
            const t = parseInt(document.getElementById('total-amount').innerText.replace('$',''));
            if(t===0) { showToast("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
            runTransaction(countRef, (c) => (c||0)+1).then(res => {
                if(res.committed) {
                    const id = String(res.snapshot.val()).padStart(3,'0');
                    const hasFood = cart.some(i=>i.group==='é£Ÿç‰©çµ„');
                    const hasDrink = cart.some(i=>i.group==='é£²æ–™çµ„');
                    push(salesRef, {
                        dbKey:'', orderId:Date.now(), displayId:id,
                        time: new Date().toLocaleTimeString('en-US',{hour12:false,hour:"2-digit",minute:"2-digit"}),
                        total:t, items:cart,
                        foodStatus: hasFood?'pending':'none', drinkStatus: hasDrink?'pending':'none'
                    });
                    showToast(`å–®è™Ÿ #${id} çµå¸³æˆåŠŸ`); playSound('sound-checkout'); window.clearCart();
                }
            });
        };

        window.renderHistory = function() {
            const c = document.getElementById('history-list'); if(!c) return;
            c.innerHTML = '';
            [...salesHistory].reverse().forEach(r => {
                const items = r.items.map(i=>`${i.name} x${i.qty}`).join(', ');
                c.innerHTML += `<div style="background:white;padding:15px;border-radius:10px;margin-bottom:10px;border-left:5px solid #64748b;display:flex;justify-content:space-between;align-items:center;"><div><b>#${r.displayId}</b> <span style="color:#64748b;font-size:0.9rem;">${r.time}</span><br><span style="font-size:0.9rem;">${items}</span></div><div style="text-align:right;"><b style="color:var(--primary);">$${r.total}</b><br><button onclick="deleteOrder('${r.dbKey}')" style="color:#ef4444;border:none;background:none;cursor:pointer;">åˆªé™¤</button></div></div>`;
            });
        };
        window.deleteOrder = function(k) { if(confirm("ç¢ºå®šåˆªé™¤?")) remove(ref(db, `sales/${k}`)); };

        // --- Kitchen Logic (å®Œæˆè¨‚å–®å„ªåŒ–ç‰ˆ) ---
        window.setKitchenMode = function(m) {
            kitchenViewMode = m;
            document.getElementById('btn-k-pending').classList.toggle('active', m==='pending');
            document.getElementById('btn-k-history').classList.toggle('active', m==='history');
            renderKitchen();
        };

        window.renderKitchen = function() {
            const c = document.getElementById('kitchen-orders');
            const target = currentRole === 'food' ? 'é£Ÿç‰©çµ„' : 'é£²æ–™çµ„';
            let html = '';
            const list = [...salesHistory].reverse();
            
            list.forEach(o => {
                // ç¨ç«‹åˆ¤æ–·è©²çµ„ç‹€æ…‹
                let status = target === 'é£Ÿç‰©çµ„' ? o.foodStatus : o.drinkStatus;
                
                if (kitchenViewMode === 'pending' && status !== 'pending') return;
                if (kitchenViewMode === 'history' && (status === 'pending' || status === 'none')) return;

                const items = o.items ? o.items.filter(i => i.group === target) : [];
                if(items.length > 0) {
                    const rows = items.map(i => `<div style="margin-bottom:5px;border-bottom:1px dashed #374151;padding-bottom:5px;"><div style="display:flex;justify-content:space-between;"><span>${i.name}</span><b>x${i.qty}</b></div>${i.note?`<div style="color:#fbbf24;font-size:0.9rem;">âš ï¸ ${i.note}</div>`:''}</div>`).join('');
                    const border = target === 'é£Ÿç‰©çµ„' ? 'border-top:6px solid #f97316' : 'border-top:6px solid #0ea5e9';
                    
                    if (kitchenViewMode === 'pending') {
                        html += `<div class="ticket" style="${border}"><div class="ticket-head"><span>#${o.displayId}</span><span>${o.time}</span></div><div class="ticket-body">${rows}</div><button class="btn-done" onclick="completeKitchenOrder('${o.dbKey}','${target}')">âœ… å®Œæˆ</button></div>`;
                    } else {
                        html += `<div class="ticket history-mode" style="${border}"><div class="ticket-head" style="color:#94a3b8"><span>#${o.displayId}</span><span>${o.time}</span></div><div class="ticket-body">${rows}</div><button class="btn-undo" onclick="undoKitchenOrder('${o.dbKey}','${target}')">â†©ï¸ å¾©åŸ</button></div>`;
                    }
                }
            });
            c.innerHTML = html || `<div style="width:100%;text-align:center;margin-top:50px;color:#64748b;">${kitchenViewMode==='pending'?'ğŸ‘¨â€ğŸ³ æš«ç„¡å¾…è¾¦':'ğŸ“œ æš«ç„¡ç´€éŒ„'}</div>`;
        };

        // ç¨ç«‹æ›´æ–°ç‹€æ…‹å‡½å¼
        window.completeKitchenOrder = function(key, group) {
            const updates = {};
            if(group === 'é£Ÿç‰©çµ„') updates[`sales/${key}/foodStatus`] = 'ready';
            if(group === 'é£²æ–™çµ„') updates[`sales/${key}/drinkStatus`] = 'ready';
            update(ref(db), updates);
        };

        window.undoKitchenOrder = function(key, group) {
            if(!confirm("ç¢ºå®šå¾©åŸè‡³å¾…è¾¦?")) return;
            const updates = {};
            if(group === 'é£Ÿç‰©çµ„') updates[`sales/${key}/foodStatus`] = 'pending';
            if(group === 'é£²æ–™çµ„') updates[`sales/${key}/drinkStatus`] = 'pending';
            update(ref(db), updates);
        };

        // --- Pickup Logic ---
        window.renderPickup = function() {
            const c = document.getElementById('pickup-orders');
            let html = '';
            salesHistory.forEach(o => {
                // é‚è¼¯ï¼šæœ‰è²·è©²çµ„æ±è¥¿ï¼Œä¸”è©²çµ„å·²ç¶“readyï¼Œä¸”é‚„æ²’picked
                // å¦‚æœåªè²·é£Ÿç‰©ï¼Œä¸ç®¡é£²æ–™ç‹€æ…‹ã€‚å¦‚æœéƒ½è²·ï¼Œéƒ½è¦readyæ‰é¡¯ç¤ºã€‚
                if(!o.items) return;
                const hasFood = o.items.some(i => i.group === 'é£Ÿç‰©çµ„');
                const hasDrink = o.items.some(i => i.group === 'é£²æ–™çµ„');
                
                // åˆ¤æ–·æ˜¯å¦æº–å‚™å¥½ (æ²’è²·å°±ç®—æº–å‚™å¥½)
                const foodReady = !hasFood || o.foodStatus === 'ready';
                const drinkReady = !hasDrink || o.drinkStatus === 'ready';
                
                // åˆ¤æ–·æ˜¯å¦å·²å–èµ°
                const foodPicked = hasFood && o.foodStatus === 'picked';
                const drinkPicked = hasDrink && o.drinkStatus === 'picked';
                
                // é¡¯ç¤ºæ¢ä»¶ï¼šå…¨éƒ¨æº–å‚™å¥½ï¼Œä¸”å°šæœªå…¨éƒ¨å–èµ°
                if (foodReady && drinkReady && (!foodPicked && !drinkPicked)) {
                     // åªæœ‰ç•¶ (æœ‰è²·ä¸”æ²’å–) æ‰ç®—é‚„åœ¨æ¶ä¸Šã€‚ç°¡å–®ä¾†èªªåªè¦æœ‰ä¸€å€‹æ²’pickedå°±æ˜¯æ²’å–ã€‚
                     // æ›´ç²¾ç¢ºï¼šé¡¯ç¤ºæ¢ä»¶æ˜¯ (foodReady && drinkReady) AND (foodStatus!='picked' || drinkStatus!='picked')
                     // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šåªè¦ç‹€æ…‹æ˜¯ ready å°±é¡¯ç¤º
                     
                     // æ‰¾å‡ºéœ€è¦é¡¯ç¤ºçš„å“é …
                     const displayItems = o.items.filter(i => (i.group==='é£Ÿç‰©çµ„'||i.group==='é£²æ–™çµ„'));
                     const rows = displayItems.map(i => `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #e2e8f0;margin-bottom:5px;"><span>${i.name}</span><span>x${i.qty}</span></div>`).join('');
                     
                     html += `<div class="pickup-card"><div class="pickup-head">#${o.displayId}</div><div class="pickup-body" style="padding:15px;">${rows}</div><button class="btn-picked" onclick="pickupDone('${o.dbKey}')">ğŸ‘Œ å·²å–é¤</button></div>`;
                }
            });
            c.innerHTML = html || '<div style="width:100%;text-align:center;margin-top:50px;color:#64748b;font-size:1.5rem;">ğŸµ æš«ç„¡å¾…å–è¨‚å–®</div>';
        };

        window.pickupDone = function(key) {
            const o = salesHistory.find(x => x.dbKey === key); if(!o) return;
            const updates = {};
            if(o.foodStatus === 'ready') updates[`sales/${key}/foodStatus`] = 'picked';
            if(o.drinkStatus === 'ready') updates[`sales/${key}/drinkStatus`] = 'picked';
            update(ref(db), updates);
            playSound('sound-checkout');
        };

        // --- P&L & Bookkeeping (æç›Šè¡¨å„ªåŒ–ç‰ˆ) ---
        window.showProfitAnalysis = function() { document.getElementById('profit-analysis-modal').style.display='flex'; updateProfit(); };
        window.hideProfitAnalysis = function() { document.getElementById('profit-analysis-modal').style.display='none'; };
        
        window.updateProfit = function() {
            const groups = ["é£Ÿç‰©çµ„", "é£²æ–™çµ„", "éŠæˆ²çµ„", "å‹•æ¼«çµ„"];
            let rev = {}, cost = {}, totalRev = 0, totalCost = 0;
            
            // åˆå§‹åŒ–
            groups.forEach(g => { rev[g] = 0; cost[g] = 0; });

            // ç®—ç‡Ÿæ”¶
            salesHistory.forEach(o => {
                o.items.forEach(i => {
                    if (rev[i.group] !== undefined) rev[i.group] += (i.price * i.qty);
                });
            });

            // ç®—æˆæœ¬
            expenseRecords.forEach(e => {
                if (cost[e.group] !== undefined) cost[e.group] += e.amount;
            });

            // ç”¢ç”Ÿè¡¨æ ¼
            let html = '';
            groups.forEach(g => {
                totalRev += rev[g]; totalCost += cost[g];
                const net = rev[g] - cost[g];
                html += `<tr>
                    <td>${g}</td>
                    <td>$${rev[g]}</td>
                    <td><button onclick="openExpense('${g}')" style="background:#f1f5f9;border:1px solid #ddd;padding:5px 10px;cursor:pointer;border-radius:6px;">$${cost[g]} âœ</button></td>
                    <td style="color:${net>=0?'var(--success)':'var(--danger)'};font-weight:bold;">$${net}</td>
                </tr>`;
            });
            document.getElementById('group-profit-body').innerHTML = html;
            
            // ç¸½çµå¡ç‰‡
            const netTotal = totalRev - totalCost;
            document.getElementById('summary-cards').innerHTML = `
                <div style="background:#dbeafe;padding:15px;border-radius:10px;">ç‡Ÿæ”¶<br><b style="font-size:1.5rem">$${totalRev}</b></div>
                <div style="background:#fef3c7;padding:15px;border-radius:10px;">æˆæœ¬<br><b style="font-size:1.5rem">$${totalCost}</b></div>
                <div style="background:#dcfce7;padding:15px;border-radius:10px;">æ·¨åˆ©<br><b style="font-size:1.5rem;color:${netTotal>=0?'#16a34a':'#dc2626'}">$${netTotal}</b></div>
            `;
        };

        // è¨˜å¸³ç›¸é—œ
        window.openExpense = function(g) { currentEditingGroup=g; document.getElementById('expense-modal-title').innerText=g; renderExpenseList(); document.getElementById('expense-manager-modal').style.display='flex'; };
        window.closeExpenseManager = function() { document.getElementById('expense-manager-modal').style.display='none'; };
        
        window.addExpense = function() {
            const b = document.getElementById('ex-buyer').value;
            const n = document.getElementById('ex-note').value;
            const a = parseInt(document.getElementById('ex-amt').value);
            if(b && n && !isNaN(a)) {
                push(expensesRef, { group: currentEditingGroup, buyer: b, note: n, amount: a });
                document.getElementById('ex-amt').value = '';
            }
        };

        window.renderExpenseList = function() {
            const list = expenseRecords.filter(e => e.group === currentEditingGroup);
            // é€™è£¡å¦‚æœè¦åˆªé™¤æ”¯å‡ºï¼Œéœ€è¦ dbKeyï¼Œä½†ç›®å‰çµæ§‹æ˜¯é™£åˆ—å­˜å–æ¯”è¼ƒéº»ç…©ã€‚
            // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡åƒ…åšé¡¯ç¤ºï¼Œè‹¥éœ€åˆªé™¤å»ºè­°ç›´æ¥é‡ç½®æˆ–å¾ŒçºŒå†åŠ å¼·
            // é€™è£¡é¡¯ç¤ºæœ€å¾Œ5ç­†ï¼Œé¿å…å¤ªé•·
            let html = '';
            list.forEach(e => {
                html += `<tr><td>${e.buyer}</td><td>${e.note}</td><td>$${e.amount}</td><td></td></tr>`;
            });
            document.getElementById('expense-list-body').innerHTML = html;
            const total = list.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('expense-total-display').innerText = total;
        };

        // --- Download Reports (å ±è¡¨ä¸‹è¼‰å„ªåŒ–ç‰ˆ) ---
        window.downloadSmartCSV = function() {
            if(salesHistory.length === 0) { showToast("ç„¡ç‡Ÿæ”¶è³‡æ–™"); return; }
            const target = document.getElementById('export-target').value;
            
            // åŠ å…¥ BOM \uFEFF è®“ Excel è¾¨è­˜ UTF-8
            let csv = "\uFEFFè¨‚å–®æ™‚é–“,å–®è™Ÿ,çµ„åˆ¥,å“é …,æ•¸é‡,å–®åƒ¹,å°è¨ˆ,å‚™è¨»\n";
            
            salesHistory.forEach(order => {
                order.items.forEach(item => {
                    if (target === 'All' || item.group === target) {
                        csv += `${order.time},${order.displayId},${item.group},${item.name},${item.qty},${item.price},${item.price * item.qty},${item.note || ''}\n`;
                    }
                });
            });

            downloadFile(csv, `ç‡Ÿæ”¶å ±è¡¨_${target}.csv`);
        };

        window.downloadExpenseCSV = function() {
            if(expenseRecords.length === 0) { showToast("ç„¡æ”¯å‡ºè³‡æ–™"); return; }
            let csv = "\uFEFFçµ„åˆ¥,ä»£å¢Šäºº,é …ç›®,é‡‘é¡\n";
            expenseRecords.forEach(e => {
                csv += `${e.group},${e.buyer},${e.note},${e.amount}\n`;
            });
            downloadFile(csv, `æ”¯å‡ºæ˜ç´°ç¸½è¡¨.csv`);
        };

        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Utils ---
        window.showToast = function(msg) {
            const box = document.getElementById('toast-box');
            const d = document.createElement('div'); d.className = 'toast'; d.innerText = msg;
            box.appendChild(d); setTimeout(() => d.remove(), 3000);
        };
        
        window.openMenuEditor = function() { document.getElementById('menu-editor-modal').style.display='flex'; document.getElementById('menu-editor-body').innerHTML=''; products.forEach(p => addEditorRow(p)); };
        window.closeMenuEditor = function() { document.getElementById('menu-editor-modal').style.display='none'; };
        window.addNewProductRow = function() { addEditorRow(); };
        function addEditorRow(p=null) {
            const b=document.getElementById('menu-editor-body'); const r=document.createElement('tr');
            const grps = ["é£Ÿç‰©çµ„", "é£²æ–™çµ„", "éŠæˆ²çµ„", "å‹•æ¼«çµ„"];
            const opts = grps.map(g=>`<option value="${g}" ${p&&p.group===g?'selected':''}>${g}</option>`).join('');
            const chk = p && p.soldOut ? 'checked' : '';
            r.innerHTML=`<td><input type="checkbox" class="e-sold" ${chk}> å®Œå”®</td><td><select class="e-g" style="padding:5px;">${opts}</select></td><td><input class="e-n" value="${p?p.name:''}" style="padding:5px;width:100px;"></td><td><input class="e-p" type="number" value="${p?p.price:0}" style="padding:5px;width:60px;"></td><td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;">ğŸ—‘ï¸</button></td>`;
            b.appendChild(r);
        }
        window.saveMenuChanges = function() {
            const rs=document.querySelectorAll('#menu-editor-body tr'); const np=[];
            rs.forEach(r=>{
                const n=r.querySelector('.e-n').value.trim();
                if(n) np.push({id:Date.now()+Math.random(), group:r.querySelector('.e-g').value, name:n, price:parseInt(r.querySelector('.e-p').value)||0, soldOut:r.querySelector('.e-sold').checked});
            });
            set(menuRef, np); window.closeMenuEditor(); showToast("èœå–®å·²æ›´æ–°");
        };
        window.resetAllData = function() { 
            if(prompt("âš ï¸ è­¦å‘Šï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼\nğŸ”’ ç®¡ç†å“¡å¯†ç¢¼ï¼š") === 'z.c.huang'){ remove(ref(db)); alert("âœ… å·²é‡ç½®"); location.reload(); } else { alert("ğŸš« éŒ¯èª¤"); }
        };
        
        setInterval(() => {
            const t = new Date();
            const time = t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0');
            const el = document.getElementById('kitchen-clock'); if(el) el.innerText = time;
        }, 1000);

    </script>
</body>
</html>
